use 5.40.0;
use utf8;

use CPU::Z80::Assembler;
use IO::File;

$CPU::Z80::Assembler::verbose = 1;
$CPU::Z80::Assembler::fill_byte = 0x00;

my $binary = z80asm(q{
	org 0x0100
Header:
    nop
    jp Start

    ; Nintendo logo
    defb $CE, $ED, $66, $66, $CC, $0D, $00, $0B, $03, $73, $00, $83, $00, $0C, $00, $0D
    defb $00, $08, $11, $1F, $88, $89, $00, $0E, $DC, $CC, $6E, $E6, $DD, $DD, $D9, $99
    defb $BB, $BB, $67, $63, $6E, $0E, $EC, $CC, $DD, $DC, $99, $9F, $BB, $B9, $33, $3E

    ; Title
    defb 'V','R','C','h','a','t',' ','L','o','g','o'

    ; Manufacturer code
    defb $00, $00, $00, $00
    ; CGB flag
    defb $00
    ; New licencee code
    defb $30, $30  ; None
    ; SGB flag
    defb $00       ; No SGB functions
    ; Cartridge type
    defb $00       ; ROM ONLY
    ; ROM size
    defb $00       ; 32KiB
    ; RAM size
    defb $00       ; 0
    ; Destination code
    defb $00       ; Japan (and possibly overseas)
    ; Old licencee code
    defb $00       ; None
    ; Mask ROM version number
    defb $00
    ; Header checksum (Fix by rgbfix)
    defb $00
    ; Global checksum (Fix by rgbfix)
    defb $00, $00

Start:
	; Do not turn the LCD off outside of VBlank
WaitVBlank:
	; ld a, [$FF44]  ; rLY
	ld hl, $FF44
	ld a, (hl)
	cp 144
	jp c, WaitVBlank

	; Turn the LCD off
	ld a, 0
	;ld [$FF40], a  ; rLCDC
	ld hl, $FF40
	ld (hl), a

	; Load character tiles into VRAM
    ld hl, CharTiles
    ld de, $8000  ; VRAM address for character tiles
    ld bc, CharTilesEnd - CharTiles
    call LoadVRAM

    ; Load Tile map into VRAM
    ld hl, VRChatMap
    ld de, $9800  ; VRAM address for BG Map
    ld bc, VRChatMapEnd - VRChatMap
    call LoadVRAM

	; Enable LCD
    ld a, $91 ; LCDCF_ON | LCDCF_BG8000 | LCDCF_BGON
	;ld [$FF40], a  ; rLCDC
	ld hl, $FF40
	ld (hl), a

    ; Set BG palette
    ld a, $E4
    ;ld [$FF47], a  ; rBGP
	ld hl, $FF47
	ld (hl), a

WaitLoop:
	halt
	jr WaitLoop

LoadVRAM:
    ld a, (hl)
    inc hl
    ld (de), a
    inc de
    dec bc
    ld a, b
    or c
    jr nz, LoadVRAM
    ret

VRChatMap:
    defb $00,$00,$00,$00,$00,$00,$00,$00,$00,$00,$00,$00,$00,$00,$00,$00,$00,$00,$00,$00,0,0,0,0,0,0,0,0,0,0,0,0
    defb $00,$00,$00,$00,$00,$00,$00,$00,$00,$00,$00,$00,$00,$00,$00,$00,$00,$00,$00,$00,0,0,0,0,0,0,0,0,0,0,0,0
    defb $00,$00,$00,$00,$00,$00,$00,$00,$00,$00,$00,$00,$00,$00,$00,$00,$00,$00,$00,$00,0,0,0,0,0,0,0,0,0,0,0,0
    defb $00,$00,$00,$00,$00,$00,$00,$00,$00,$00,$00,$00,$00,$00,$00,$00,$00,$00,$00,$00,0,0,0,0,0,0,0,0,0,0,0,0
    defb $00,$00,$00,$00,$00,$00,$00,$00,$00,$00,$00,$00,$00,$00,$00,$00,$00,$00,$00,$00,0,0,0,0,0,0,0,0,0,0,0,0
    defb $00,$00,$00,$00,$00,$00,$00,$00,$00,$00,$00,$00,$00,$00,$00,$00,$00,$00,$00,$00,0,0,0,0,0,0,0,0,0,0,0,0
    defb $00,$01,$02,$02,$02,$02,$02,$02,$02,$02,$02,$02,$02,$02,$02,$02,$02,$03,$00,$00,0,0,0,0,0,0,0,0,0,0,0,0
    defb $00,$06,$0E,$00,$15,$0C,$1C,$20,$24,$28,$2D,$31,$35,$39,$3D,$41,$45,$04,$00,$00,0,0,0,0,0,0,0,0,0,0,0,0
    defb $00,$06,$0F,$12,$16,$19,$1D,$21,$25,$29,$2E,$32,$36,$3A,$3E,$42,$46,$04,$00,$00,0,0,0,0,0,0,0,0,0,0,0,0
    defb $00,$06,$10,$13,$17,$1A,$1E,$22,$26,$2A,$2F,$33,$37,$3B,$3F,$43,$47,$04,$00,$00,0,0,0,0,0,0,0,0,0,0,0,0
    defb $00,$06,$11,$14,$18,$1B,$1F,$23,$27,$2B,$30,$34,$38,$3C,$40,$44,$48,$04,$00,$00,0,0,0,0,0,0,0,0,0,0,0,0
    defb $00,$0D,$0C,$0C,$0C,$0C,$0C,$0C,$0C,$0C,$0C,$0C,$0C,$0C,$0C,$0B,$00,$05,$00,$00,0,0,0,0,0,0,0,0,0,0,0,0
    defb $00,$00,$00,$00,$00,$00,$00,$00,$00,$00,$00,$00,$00,$00,$00,$0A,$09,$06,$00,$00,0,0,0,0,0,0,0,0,0,0,0,0
    defb $00,$00,$00,$00,$00,$00,$00,$00,$00,$00,$00,$00,$00,$00,$00,$00,$08,$07,$00,$00,0,0,0,0,0,0,0,0,0,0,0,0
    defb $00,$00,$00,$00,$00,$00,$00,$00,$00,$00,$00,$00,$00,$00,$00,$00,$00,$00,$00,$00,0,0,0,0,0,0,0,0,0,0,0,0
    defb $00,$00,$00,$00,$00,$00,$00,$00,$00,$00,$00,$00,$00,$00,$00,$00,$00,$00,$00,$00,0,0,0,0,0,0,0,0,0,0,0,0
    defb $00,$00,$00,$00,$00,$00,$00,$00,$00,$00,$00,$00,$00,$00,$00,$00,$00,$00,$00,$00,0,0,0,0,0,0,0,0,0,0,0,0
    defb $00,$00,$00,$00,$00,$00,$00,$00,$00,$00,$00,$00,$00,$00,$00,$00,$00,$00,$00,$00,0,0,0,0,0,0,0,0,0,0,0,0
VRChatMapEnd:

CharTiles:
    defb $00,$00,$00,$00,$00,$00,$00,$00,$00,$00,$00,$00,$00,$00,$00,$00
    defb $00,$00,$00,$00,$00,$00,$0F,$0F,$1F,$1F,$3F,$3F,$78,$78,$70,$70
    defb $00,$00,$00,$00,$00,$00,$FF,$FF,$FF,$FF,$FF,$FF,$00,$00,$00,$00
    defb $00,$00,$00,$00,$00,$00,$F0,$F0,$F8,$F8,$FC,$FC,$1E,$1E,$0E,$0E
    defb $07,$07,$07,$07,$07,$07,$07,$07,$07,$07,$07,$07,$07,$07,$07,$07
    defb $07,$07,$07,$07,$07,$07,$0E,$0E,$1E,$1E,$FC,$FC,$F8,$F8,$F0,$F0
    defb $E0,$E0,$E0,$E0,$E0,$E0,$E0,$E0,$E0,$E0,$E0,$E0,$E0,$E0,$E0,$E0
    defb $E0,$E0,$E0,$E0,$E0,$E0,$E0,$E0,$E0,$E0,$E0,$E0,$C0,$C0,$80,$80
    defb $E0,$E0,$70,$70,$38,$38,$1C,$1C,$0E,$0E,$07,$07,$03,$03,$01,$01
    defb $00,$00,$00,$00,$00,$00,$00,$00,$80,$80,$C0,$C0,$C0,$C0,$E0,$E0
    defb $3C,$3C,$1E,$1E,$0F,$0F,$07,$07,$07,$07,$03,$03,$01,$01,$00,$00
    defb $00,$00,$00,$00,$00,$00,$00,$00,$00,$00,$F0,$F0,$F0,$F0,$F8,$F8
    defb $00,$00,$00,$00,$00,$00,$00,$00,$00,$00,$FF,$FF,$FF,$FF,$FF,$FF
    defb $E0,$E0,$E0,$E0,$E0,$E0,$70,$70,$78,$78,$3F,$3F,$1F,$1F,$0F,$0F
    defb $00,$00,$00,$00,$00,$00,$00,$00,$00,$00,$18,$18,$3C,$3C,$3C,$3C
    defb $3C,$3C,$1E,$1E,$1E,$1E,$1E,$1E,$0E,$0E,$0F,$0F,$0F,$0F,$07,$07
    defb $07,$07,$07,$07,$03,$03,$03,$03,$03,$03,$03,$03,$01,$01,$01,$01
    defb $01,$01,$00,$00,$00,$00,$00,$00,$00,$00,$00,$00,$00,$00,$00,$00
    defb $00,$00,$01,$01,$01,$01,$01,$01,$01,$01,$03,$03,$03,$03,$03,$03
    defb $87,$87,$87,$87,$87,$87,$87,$87,$87,$87,$CF,$CF,$CE,$CE,$FE,$FE
    defb $FE,$FE,$FC,$FC,$FC,$FC,$78,$78,$78,$78,$30,$30,$00,$00,$00,$00
    defb $00,$00,$00,$00,$00,$00,$00,$00,$00,$00,$60,$60,$F1,$F1,$F1,$F1
    defb $F1,$F1,$E1,$E1,$E1,$E1,$E1,$E1,$C1,$C1,$C1,$C1,$C1,$C1,$81,$81
    defb $81,$81,$81,$81,$01,$01,$01,$01,$01,$01,$01,$01,$01,$01,$01,$01
    defb $01,$01,$01,$01,$01,$01,$01,$01,$01,$01,$00,$00,$00,$00,$00,$00
    defb $FF,$FF,$E0,$E0,$E0,$E0,$E0,$E0,$E0,$E0,$E0,$E0,$E0,$E0,$E0,$E0
    defb $FF,$FF,$FF,$FF,$FF,$FF,$FF,$FF,$FF,$FF,$E1,$E1,$E0,$E0,$E0,$E0
    defb $E0,$E0,$E0,$E0,$E0,$E0,$E0,$E0,$E0,$E0,$C0,$C0,$00,$00,$00,$00
    defb $00,$00,$00,$00,$00,$00,$00,$00,$00,$00,$C0,$C0,$F0,$F0,$F8,$F8
    defb $FC,$FC,$7C,$7C,$3E,$3E,$1E,$1E,$1E,$1E,$1E,$1E,$3E,$3E,$7C,$7C
    defb $FC,$FC,$F8,$F8,$E0,$E0,$C0,$C0,$E0,$E0,$F0,$F0,$F0,$F0,$F8,$F8
    defb $78,$78,$78,$78,$3C,$3C,$3C,$3C,$3C,$3C,$18,$18,$00,$00,$00,$00
    defb $00,$00,$00,$00,$00,$00,$1F,$1F,$3F,$3F,$7F,$7F,$7F,$7F,$7E,$7E
    defb $7C,$7C,$7C,$7C,$78,$78,$78,$78,$78,$78,$78,$78,$78,$78,$78,$78
    defb $78,$78,$78,$78,$78,$78,$78,$78,$78,$78,$78,$78,$78,$78,$78,$78
    defb $78,$78,$7C,$7C,$7C,$7C,$7E,$7E,$7F,$7F,$7F,$7F,$3F,$3F,$1F,$1F
    defb $00,$00,$00,$00,$00,$00,$FF,$FF,$FF,$FF,$C1,$C1,$00,$00,$00,$00
    defb $00,$00,$1C,$1C,$3E,$3E,$7F,$7F,$7F,$7F,$7F,$7F,$7F,$7F,$7F,$7F
    defb $7F,$7F,$7F,$7F,$7F,$7F,$7F,$7F,$7F,$7F,$7F,$7F,$7F,$7F,$7F,$7F
    defb $3E,$3E,$1C,$1C,$00,$00,$00,$00,$00,$00,$C1,$C1,$FF,$FF,$FF,$FF
    defb $00,$00,$00,$00,$00,$00,$FF,$FF,$FF,$FF,$FF,$FF,$7F,$7F,$3F,$3F
    defb $1F,$1F,$1F,$1F,$0F,$0F,$0F,$0F,$0F,$0F,$9F,$9F,$FF,$FF,$FF,$FF
    defb $FF,$FF,$FF,$FF,$FF,$FF,$FF,$FF,$FF,$FF,$9F,$9F,$0F,$0F,$0F,$0F
    defb $0F,$0F,$1F,$1F,$1F,$1F,$3F,$3F,$7F,$7F,$FF,$FF,$FF,$FF,$FF,$FF
    defb $FF,$FF,$FF,$FF,$FF,$FF,$FF,$FF,$FF,$FF,$FF,$FF,$FF,$FF,$FF,$FF
    defb $00,$00,$00,$00,$00,$00,$FF,$FF,$FF,$FF,$9F,$9F,$0F,$0F,$0F,$0F
    defb $0F,$0F,$0F,$0F,$0F,$0F,$0F,$0F,$0F,$0F,$0F,$0F,$0F,$0F,$00,$00
    defb $00,$00,$00,$00,$00,$00,$0F,$0F,$0F,$0F,$0F,$0F,$0F,$0F,$0F,$0F
    defb $0F,$0F,$0F,$0F,$0F,$0F,$0F,$0F,$0F,$0F,$9F,$9F,$FF,$FF,$FF,$FF
    defb $00,$00,$00,$00,$00,$00,$FF,$FF,$FF,$FF,$F3,$F3,$E1,$E1,$E1,$E1
    defb $E1,$E1,$E1,$E1,$E1,$E1,$E1,$E1,$E1,$E1,$E1,$E1,$E1,$E1,$01,$01
    defb $01,$01,$01,$01,$01,$01,$E1,$E1,$E1,$E1,$E1,$E1,$E1,$E1,$E1,$E1
    defb $E1,$E1,$E1,$E1,$E1,$E1,$E1,$E1,$E1,$E1,$F3,$F3,$FF,$FF,$FF,$FF
    defb $00,$00,$00,$00,$00,$00,$FF,$FF,$FF,$FF,$FF,$FF,$FF,$FF,$FF,$FF
    defb $FF,$FF,$FF,$FF,$FE,$FE,$FE,$FE,$FE,$FE,$FC,$FC,$FC,$FC,$FC,$FC
    defb $F8,$F8,$F8,$F8,$F8,$F8,$F0,$F0,$F0,$F0,$F0,$F0,$F0,$F0,$E0,$E0
    defb $E0,$E0,$E1,$E1,$C3,$C3,$C3,$C3,$C3,$C3,$E7,$E7,$FF,$FF,$FF,$FF
    defb $00,$00,$00,$00,$00,$00,$FF,$FF,$FF,$FF,$CF,$CF,$87,$87,$03,$03
    defb $03,$03,$03,$03,$01,$01,$01,$01,$31,$31,$30,$30,$30,$30,$78,$78
    defb $78,$78,$78,$78,$FC,$FC,$FC,$FC,$FC,$FC,$00,$00,$00,$00,$00,$00
    defb $00,$00,$FE,$FE,$FF,$FF,$FF,$FF,$FF,$FF,$FF,$FF,$FF,$FF,$FF,$FF
    defb $00,$00,$00,$00,$00,$00,$FF,$FF,$FF,$FF,$F8,$F8,$F0,$F0,$F0,$F0
    defb $F8,$F8,$FF,$FF,$FF,$FF,$FF,$FF,$FF,$FF,$FF,$FF,$FF,$FF,$FF,$FF
    defb $7F,$7F,$7F,$7F,$7F,$7F,$3F,$3F,$3F,$3F,$3F,$3F,$3F,$3F,$1F,$1F
    defb $1F,$1F,$1F,$1F,$0F,$0F,$0F,$0F,$0F,$0F,$9F,$9F,$FF,$FF,$FF,$FF
    defb $00,$00,$00,$00,$00,$00,$FF,$FF,$FF,$FF,$00,$00,$00,$00,$00,$00
    defb $00,$00,$C3,$C3,$C3,$C3,$C3,$C3,$C3,$C3,$C3,$C3,$C3,$C3,$C3,$C3
    defb $C3,$C3,$C3,$C3,$C3,$C3,$C3,$C3,$C3,$C3,$C3,$C3,$C3,$C3,$C3,$C3
    defb $C3,$C3,$C3,$C3,$C3,$C3,$C3,$C3,$C3,$C3,$E7,$E7,$FF,$FF,$FF,$FF
    defb $00,$00,$00,$00,$00,$00,$FF,$FF,$FF,$FF,$1F,$1F,$0F,$0F,$0F,$0F
    defb $1F,$1F,$FF,$FF,$FF,$FF,$FF,$FF,$FF,$FF,$FF,$FF,$FF,$FF,$FF,$FF
    defb $FF,$FF,$FF,$FF,$FF,$FF,$FF,$FF,$FF,$FF,$FF,$FF,$FF,$FF,$FF,$FF
    defb $FF,$FF,$FF,$FF,$FF,$FF,$FF,$FF,$FF,$FF,$FF,$FF,$FE,$FE,$FC,$FC
CharTilesEnd:
});

$binary = ("\x00" x 0x100) . $binary;

use Data::Dumper;
print Dumper($binary);

my $file = IO::File->new('perl.gb', 'w') or die "Could not open file: $!";
$file->binmode;
$file->print($binary);
$file->close;

